#!/bin/bash
set -e

cd $(dirname $0)/..

echo Running validation

PACKAGES="$(go list ./...)"

echo Running: check docs are up-to-date
# Validate that there are no unexpected changes in docs after running the doc script
# Ignore changes related to lines starting with "###### Auto generated by spf13/cobra on ..."
bash ./dapper/doc

set +e
actual_changes=$(git diff -- 'docs/' | grep -E '^[+-]' | grep -vE '^(\+\+\+|---)' | grep -vE '^[-+]###### Auto generated by spf13/cobra on ')
if [ -n "$actual_changes" ]; then
    echo "Docs are not up-to-date. Please run 'make doc' to update them."
    echo "$actual_changes"
    exit 1
fi
set -e


echo Running: go vet
# shellcheck disable=SC2086
go vet ${PACKAGES}

echo Running: golangci-lint
golangci-lint run --timeout=5m

echo Running: go fmt
test -z "$(go fmt ${PACKAGES} | tee /dev/stderr)"
